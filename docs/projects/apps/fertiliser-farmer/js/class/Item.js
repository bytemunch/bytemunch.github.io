import { WorldActor } from './WorldActor.js';
import { tileGrid, itemManifest, sprites, randInRange, inventory, layers, LAYERNUMBERS, extraActors } from '../main.js';
import { Coin, XPDrop, ItemDrop } from './Drop.js';
export const newItemFromJSON = (data) => {
    return new Item({
        gridPosition: { gridX: data.gridX, gridY: data.gridY },
        sprite: sprites[data.type + '-' + data.level],
        level: data.level,
        type: data.type
    });
};
export class Item extends WorldActor {
    constructor(options) {
        super(options);
        this.layer = LAYERNUMBERS.item;
        this.width = 32;
        this.height = 32;
        this.level = options.level || 1;
    }
    toJSON() {
        return {
            type: this.type,
            layer: this.layer,
            gridX: this.gridX,
            gridY: this.gridY,
            level: this.level
        };
    }
    get xOffset() {
        return this.width / 2 + (this.gridY % 2 == 0 ? this.width : 0);
    }
    get yOffset() {
        return -this.height / 2;
    }
    get draggable() {
        return (tileGrid[this.gridX][this.gridY].tile.type == 'grass');
    }
    draw() {
        if ((this.gridX == -1 || this.gridY == -1) || tileGrid[this.gridX][this.gridY].tile.type == 'grass')
            return super.draw();
        return false;
    }
    getConnectedItemsOfSameTypeAndLevel(targetType, targetLevel) {
        let tile = tileGrid[this.gridX][this.gridY].tile;
        let connected = [tile.ne.contents, tile.nw.contents, tile.sw.contents, tile.se.contents];
        return connected.filter(item => item && item.type == targetType && item.level == targetLevel && tileGrid[item.gridX][item.gridY].tile.type == 'grass');
    }
    complete() {
        // console.log('Not implemented: Item Completed');
        // Use drop table here
        for (let drop in itemManifest[this.type].dropTable) {
            let nums = itemManifest[this.type].dropTable[drop];
            let amt = randInRange(nums[0], nums[1]);
            for (let i = 0; i < amt; i++) {
                switch (drop) {
                    case 'coin':
                        extraActors.push(new Coin({
                            left: this.x,
                            top: this.y,
                            height: 16,
                            width: 16,
                            type: 'coin',
                            sprite: sprites.coin,
                            targetPos: [layers[0].cnv.width, 0],
                            value: 1
                        }));
                        break;
                    case 'xp':
                        extraActors.push(new XPDrop({
                            left: this.x,
                            top: this.y,
                            height: 16,
                            width: 16,
                            type: 'xp',
                            sprite: sprites.xp,
                            targetPos: [0, 0],
                            value: 10
                        }));
                        i += 9;
                        break;
                    default:
                        let droppedItem = new ItemDrop({
                            left: this.x,
                            top: this.y,
                            height: 16,
                            width: 16,
                            type: drop.split('-')[0],
                            sprite: sprites[drop],
                            targetPos: [layers[0].cnv.width / 2, 0],
                            value: 1,
                            finish: () => inventory.addByTypeAndLevel(drop.split('-')[0], drop.split('-')[1])
                        });
                        droppedItem.level = drop.split('-')[1];
                        extraActors.push(droppedItem);
                        // console.log('Drop not implemented:', drop);
                        break;
                }
            }
        }
    }
    dropXpForMerge(numUpgraded) {
        let numBalls = numUpgraded * (itemManifest[this.type].dropTable.xp[0] / 10) * this.level;
        for (let i = 0; i < numBalls; i++) {
            extraActors.push(new XPDrop({
                left: this.x,
                top: this.y,
                height: 8,
                width: 8,
                type: 'xp',
                sprite: sprites.coin,
                targetPos: [0, 0],
                value: Math.floor(itemManifest[this.type].dropTable.xp[0] / 20)
            }));
        }
    }
    merge(merger) {
        // check around self for other items of same type
        // build list of connected items of same type
        let connectedItems = new Set;
        let newLevel = this.level + 1;
        connectedItems.add(merger);
        // this.getConnectedItemsOfSameTypeAndLevel(this.type, this.level).forEach(item => connectedItems.add(item));
        let depth = 10;
        for (let i = 0; i < depth; i++) {
            for (let item of connectedItems) {
                // then check around that item
                item.getConnectedItemsOfSameTypeAndLevel(this.type, this.level).forEach(item => connectedItems.add(item));
            }
        }
        connectedItems.add(this);
        if (connectedItems.size < 3)
            return false;
        let numUpgraded = 0;
        let used = 0;
        // group list into 5s
        // merge each group of 5 until list size < 5
        // for each 5 create two levelled up versions
        // remove merged
        if (connectedItems.size >= 5) {
            numUpgraded = Math.floor(connectedItems.size / 5) * 2;
            used = Math.floor(connectedItems.size - connectedItems.size % 5);
        }
        // group into 3s
        // merge 3s
        // for each 3 create one levelled up version
        // remove merged 3s
        if (connectedItems.size % 5 >= 3) {
            numUpgraded++;
            used += 3;
        }
        let leftover = connectedItems.size - used;
        // done
        let i = 0;
        for (let item of connectedItems) {
            if (item.gridX != -1 && item.gridY != -1)
                tileGrid[item.gridX][item.gridY].contents = null;
            if (i < numUpgraded) {
                if (newLevel > itemManifest[item.type].maxLevel) {
                    item.complete();
                }
                else {
                    tileGrid[item.gridX][item.gridY].contents = new Item({
                        gridPosition: { gridX: item.gridX, gridY: item.gridY },
                        sprite: sprites[`${item.type}-${newLevel}`],
                        type: item.type,
                        level: newLevel
                    });
                }
            }
            else if (i < numUpgraded + leftover) {
                tileGrid[item.gridX][item.gridY].contents = new Item({
                    gridPosition: { gridX: item.gridX, gridY: item.gridY },
                    sprite: sprites[`${item.type}-${item.level}`],
                    type: item.type,
                    level: item.level
                });
            }
            i++;
        }
        this.dropXpForMerge(numUpgraded);
        return true;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RUFBRSxJQUFJLENBQUMsSUFBSTt3QkFDZixLQUFLLEVBQUUsUUFBUTtxQkFDbEIsQ0FBQyxDQUFDO2lCQUNOO2FBQ0o7aUJBQ0ksSUFBSSxDQUFDLEdBQUcsV0FBVyxHQUFHLFFBQVEsRUFBRTtnQkFDakMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxHQUFHLElBQUksSUFBSSxDQUFDO29CQUNqRCxZQUFZLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRTtvQkFDdEQsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUM3QyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7b0JBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO2lCQUNwQixDQUFDLENBQUM7YUFDTjtZQUVELENBQUMsRUFBRSxDQUFDO1NBQ1A7UUFFRCxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWpDLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSiIsImZpbGUiOiJjbGFzcy9JdGVtLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV29ybGRBY3RvciwgSUFjdG9yT3B0aW9ucyB9IGZyb20gJy4vV29ybGRBY3Rvci5qcyc7XG5pbXBvcnQgeyB0aWxlR3JpZCwgaXRlbU1hbmlmZXN0LCBzcHJpdGVzLCByYW5kSW5SYW5nZSwgY2FtZXJhLCBkcm9wTWFuaWZlc3QsIGludmVudG9yeSwgbGF5ZXJzLCBMQVlFUk5VTUJFUlMsIGV4dHJhQWN0b3JzIH0gZnJvbSAnLi4vbWFpbi5qcyc7XG5pbXBvcnQgeyBDb2luLCBYUERyb3AsIEl0ZW1Ecm9wIH0gZnJvbSAnLi9Ecm9wLmpzJztcblxuZXhwb3J0IGNvbnN0IG5ld0l0ZW1Gcm9tSlNPTiA9IChkYXRhKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBJdGVtKHtcbiAgICAgICAgZ3JpZFBvc2l0aW9uOiB7IGdyaWRYOiBkYXRhLmdyaWRYLCBncmlkWTogZGF0YS5ncmlkWSB9LFxuICAgICAgICBzcHJpdGU6IHNwcml0ZXNbZGF0YS50eXBlICsgJy0nICsgZGF0YS5sZXZlbF0sXG4gICAgICAgIGxldmVsOiBkYXRhLmxldmVsLFxuICAgICAgICB0eXBlOiBkYXRhLnR5cGVcbiAgICB9KVxufVxuZXhwb3J0IGNsYXNzIEl0ZW0gZXh0ZW5kcyBXb3JsZEFjdG9yIHtcbiAgICBsZXZlbDogbnVtYmVyO1xuICAgIGxheWVyID0gTEFZRVJOVU1CRVJTLml0ZW07XG4gICAgY29uc3RydWN0b3Iob3B0aW9ucz86IElBY3Rvck9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIob3B0aW9ucyk7XG4gICAgICAgIHRoaXMud2lkdGggPSAzMjtcbiAgICAgICAgdGhpcy5oZWlnaHQgPSAzMjtcbiAgICAgICAgdGhpcy5sZXZlbCA9IG9wdGlvbnMubGV2ZWwgfHwgMTtcbiAgICB9XG5cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiB0aGlzLnR5cGUsXG4gICAgICAgICAgICBsYXllcjogdGhpcy5sYXllcixcbiAgICAgICAgICAgIGdyaWRYOiB0aGlzLmdyaWRYLFxuICAgICAgICAgICAgZ3JpZFk6IHRoaXMuZ3JpZFksXG4gICAgICAgICAgICBsZXZlbDogdGhpcy5sZXZlbFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0IHhPZmZzZXQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLndpZHRoIC8gMiArICh0aGlzLmdyaWRZICUgMiA9PSAwID8gdGhpcy53aWR0aCA6IDApO1xuICAgIH1cblxuICAgIGdldCB5T2Zmc2V0KCkge1xuICAgICAgICByZXR1cm4gLXRoaXMuaGVpZ2h0IC8gMjtcbiAgICB9XG5cbiAgICBnZXQgZHJhZ2dhYmxlKCkge1xuICAgICAgICByZXR1cm4gKHRpbGVHcmlkW3RoaXMuZ3JpZFhdW3RoaXMuZ3JpZFldLnRpbGUudHlwZSA9PSAnZ3Jhc3MnKTtcbiAgICB9XG5cbiAgICBkcmF3KCkge1xuICAgICAgICBpZiAoKHRoaXMuZ3JpZFggPT0gLTEgfHwgdGhpcy5ncmlkWSA9PSAtMSkgfHwgdGlsZUdyaWRbdGhpcy5ncmlkWF1bdGhpcy5ncmlkWV0udGlsZS50eXBlID09ICdncmFzcycpXG4gICAgICAgICAgICByZXR1cm4gc3VwZXIuZHJhdygpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgZ2V0Q29ubmVjdGVkSXRlbXNPZlNhbWVUeXBlQW5kTGV2ZWwodGFyZ2V0VHlwZSwgdGFyZ2V0TGV2ZWwpIHtcbiAgICAgICAgbGV0IHRpbGUgPSB0aWxlR3JpZFt0aGlzLmdyaWRYXVt0aGlzLmdyaWRZXS50aWxlO1xuICAgICAgICBsZXQgY29ubmVjdGVkID0gW3RpbGUubmUuY29udGVudHMsIHRpbGUubncuY29udGVudHMsIHRpbGUuc3cuY29udGVudHMsIHRpbGUuc2UuY29udGVudHNdO1xuXG4gICAgICAgIHJldHVybiBjb25uZWN0ZWQuZmlsdGVyKGl0ZW0gPT4gaXRlbSAmJiBpdGVtLnR5cGUgPT0gdGFyZ2V0VHlwZSAmJiBpdGVtLmxldmVsID09IHRhcmdldExldmVsICYmIHRpbGVHcmlkW2l0ZW0uZ3JpZFhdW2l0ZW0uZ3JpZFldLnRpbGUudHlwZSA9PSAnZ3Jhc3MnKTtcbiAgICB9XG5cbiAgICBjb21wbGV0ZSgpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ05vdCBpbXBsZW1lbnRlZDogSXRlbSBDb21wbGV0ZWQnKTtcbiAgICAgICAgLy8gVXNlIGRyb3AgdGFibGUgaGVyZVxuXG4gICAgICAgIGZvciAobGV0IGRyb3AgaW4gaXRlbU1hbmlmZXN0W3RoaXMudHlwZV0uZHJvcFRhYmxlKSB7XG4gICAgICAgICAgICBsZXQgbnVtcyA9IGl0ZW1NYW5pZmVzdFt0aGlzLnR5cGVdLmRyb3BUYWJsZVtkcm9wXTtcbiAgICAgICAgICAgIGxldCBhbXQgPSByYW5kSW5SYW5nZShudW1zWzBdLCBudW1zWzFdKTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbXQ7IGkrKykge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoZHJvcCkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlICdjb2luJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhQWN0b3JzLnB1c2gobmV3IENvaW4oe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IHRoaXMueCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IHRoaXMueSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDE2LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxNixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29pbicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ByaXRlOiBzcHJpdGVzLmNvaW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zOiBbbGF5ZXJzWzBdLmNudi53aWR0aCwgMF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDFcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3hwJzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhQWN0b3JzLnB1c2gobmV3IFhQRHJvcCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogdGhpcy54LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogdGhpcy55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogMTYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDE2LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd4cCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ByaXRlOiBzcHJpdGVzLnhwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFBvczogWzAsIDBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAxMFxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgICAgICAgICBpICs9IDk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkcm9wcGVkSXRlbSA9IG5ldyBJdGVtRHJvcCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogdGhpcy54LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogdGhpcy55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogMTYsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDE2LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGRyb3Auc3BsaXQoJy0nKVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcHJpdGU6IHNwcml0ZXNbZHJvcF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0UG9zOiBbbGF5ZXJzWzBdLmNudi53aWR0aCAvIDIsIDBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAxLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbmlzaDogKCkgPT4gaW52ZW50b3J5LmFkZEJ5VHlwZUFuZExldmVsKGRyb3Auc3BsaXQoJy0nKVswXSwgZHJvcC5zcGxpdCgnLScpWzFdKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkcm9wcGVkSXRlbS5sZXZlbCA9IGRyb3Auc3BsaXQoJy0nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhQWN0b3JzLnB1c2goZHJvcHBlZEl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0Ryb3Agbm90IGltcGxlbWVudGVkOicsIGRyb3ApO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZHJvcFhwRm9yTWVyZ2UobnVtVXBncmFkZWQpIHtcbiAgICAgICAgbGV0IG51bUJhbGxzID0gbnVtVXBncmFkZWQgKiAoaXRlbU1hbmlmZXN0W3RoaXMudHlwZV0uZHJvcFRhYmxlLnhwWzBdIC8gMTApICogdGhpcy5sZXZlbDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1CYWxsczsgaSsrKSB7XG4gICAgICAgICAgICBleHRyYUFjdG9ycy5wdXNoKG5ldyBYUERyb3Aoe1xuICAgICAgICAgICAgICAgIGxlZnQ6IHRoaXMueCxcbiAgICAgICAgICAgICAgICB0b3A6IHRoaXMueSxcbiAgICAgICAgICAgICAgICBoZWlnaHQ6IDgsXG4gICAgICAgICAgICAgICAgd2lkdGg6IDgsXG4gICAgICAgICAgICAgICAgdHlwZTogJ3hwJyxcbiAgICAgICAgICAgICAgICBzcHJpdGU6IHNwcml0ZXMuY29pbixcbiAgICAgICAgICAgICAgICB0YXJnZXRQb3M6IFswLCAwXSxcbiAgICAgICAgICAgICAgICB2YWx1ZTogTWF0aC5mbG9vcihpdGVtTWFuaWZlc3RbdGhpcy50eXBlXS5kcm9wVGFibGUueHBbMF0gLyAyMClcbiAgICAgICAgICAgIH0pKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgbWVyZ2UobWVyZ2VyKSB7XG5cbiAgICAgICAgLy8gY2hlY2sgYXJvdW5kIHNlbGYgZm9yIG90aGVyIGl0ZW1zIG9mIHNhbWUgdHlwZVxuICAgICAgICAvLyBidWlsZCBsaXN0IG9mIGNvbm5lY3RlZCBpdGVtcyBvZiBzYW1lIHR5cGVcbiAgICAgICAgbGV0IGNvbm5lY3RlZEl0ZW1zOiBTZXQ8SXRlbT4gPSBuZXcgU2V0O1xuXG4gICAgICAgIGxldCBuZXdMZXZlbCA9IHRoaXMubGV2ZWwgKyAxO1xuXG4gICAgICAgIGNvbm5lY3RlZEl0ZW1zLmFkZChtZXJnZXIpO1xuXG4gICAgICAgIC8vIHRoaXMuZ2V0Q29ubmVjdGVkSXRlbXNPZlNhbWVUeXBlQW5kTGV2ZWwodGhpcy50eXBlLCB0aGlzLmxldmVsKS5mb3JFYWNoKGl0ZW0gPT4gY29ubmVjdGVkSXRlbXMuYWRkKGl0ZW0pKTtcblxuICAgICAgICBsZXQgZGVwdGggPSAxMDtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRlcHRoOyBpKyspIHtcbiAgICAgICAgICAgIGZvciAobGV0IGl0ZW0gb2YgY29ubmVjdGVkSXRlbXMpIHtcbiAgICAgICAgICAgICAgICAvLyB0aGVuIGNoZWNrIGFyb3VuZCB0aGF0IGl0ZW1cbiAgICAgICAgICAgICAgICBpdGVtLmdldENvbm5lY3RlZEl0ZW1zT2ZTYW1lVHlwZUFuZExldmVsKHRoaXMudHlwZSwgdGhpcy5sZXZlbCkuZm9yRWFjaChpdGVtID0+IGNvbm5lY3RlZEl0ZW1zLmFkZChpdGVtKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29ubmVjdGVkSXRlbXMuYWRkKHRoaXMpO1xuXG5cbiAgICAgICAgaWYgKGNvbm5lY3RlZEl0ZW1zLnNpemUgPCAzKVxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGxldCBudW1VcGdyYWRlZCA9IDA7XG4gICAgICAgIGxldCB1c2VkID0gMDtcblxuXG4gICAgICAgIC8vIGdyb3VwIGxpc3QgaW50byA1c1xuICAgICAgICAvLyBtZXJnZSBlYWNoIGdyb3VwIG9mIDUgdW50aWwgbGlzdCBzaXplIDwgNVxuICAgICAgICAvLyBmb3IgZWFjaCA1IGNyZWF0ZSB0d28gbGV2ZWxsZWQgdXAgdmVyc2lvbnNcbiAgICAgICAgLy8gcmVtb3ZlIG1lcmdlZFxuICAgICAgICBpZiAoY29ubmVjdGVkSXRlbXMuc2l6ZSA+PSA1KSB7XG4gICAgICAgICAgICBudW1VcGdyYWRlZCA9IE1hdGguZmxvb3IoY29ubmVjdGVkSXRlbXMuc2l6ZSAvIDUpICogMjtcbiAgICAgICAgICAgIHVzZWQgPSBNYXRoLmZsb29yKGNvbm5lY3RlZEl0ZW1zLnNpemUgLSBjb25uZWN0ZWRJdGVtcy5zaXplICUgNSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBncm91cCBpbnRvIDNzXG4gICAgICAgIC8vIG1lcmdlIDNzXG4gICAgICAgIC8vIGZvciBlYWNoIDMgY3JlYXRlIG9uZSBsZXZlbGxlZCB1cCB2ZXJzaW9uXG4gICAgICAgIC8vIHJlbW92ZSBtZXJnZWQgM3NcbiAgICAgICAgaWYgKGNvbm5lY3RlZEl0ZW1zLnNpemUgJSA1ID49IDMpIHtcbiAgICAgICAgICAgIG51bVVwZ3JhZGVkKys7XG4gICAgICAgICAgICB1c2VkICs9IDM7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbGVmdG92ZXIgPSBjb25uZWN0ZWRJdGVtcy5zaXplIC0gdXNlZDtcblxuICAgICAgICAvLyBkb25lXG4gICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgZm9yIChsZXQgaXRlbSBvZiBjb25uZWN0ZWRJdGVtcykge1xuICAgICAgICAgICAgaWYgKGl0ZW0uZ3JpZFggIT0gLTEgJiYgaXRlbS5ncmlkWSAhPSAtMSkgdGlsZUdyaWRbaXRlbS5ncmlkWF1baXRlbS5ncmlkWV0uY29udGVudHMgPSBudWxsO1xuICAgICAgICAgICAgaWYgKGkgPCBudW1VcGdyYWRlZCkge1xuICAgICAgICAgICAgICAgIGlmIChuZXdMZXZlbCA+IGl0ZW1NYW5pZmVzdFtpdGVtLnR5cGVdLm1heExldmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRpbGVHcmlkW2l0ZW0uZ3JpZFhdW2l0ZW0uZ3JpZFldLmNvbnRlbnRzID0gbmV3IEl0ZW0oe1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JpZFBvc2l0aW9uOiB7IGdyaWRYOiBpdGVtLmdyaWRYLCBncmlkWTogaXRlbS5ncmlkWSB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc3ByaXRlOiBzcHJpdGVzW2Ake2l0ZW0udHlwZX0tJHtuZXdMZXZlbH1gXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGl0ZW0udHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldmVsOiBuZXdMZXZlbFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChpIDwgbnVtVXBncmFkZWQgKyBsZWZ0b3Zlcikge1xuICAgICAgICAgICAgICAgIHRpbGVHcmlkW2l0ZW0uZ3JpZFhdW2l0ZW0uZ3JpZFldLmNvbnRlbnRzID0gbmV3IEl0ZW0oe1xuICAgICAgICAgICAgICAgICAgICBncmlkUG9zaXRpb246IHsgZ3JpZFg6IGl0ZW0uZ3JpZFgsIGdyaWRZOiBpdGVtLmdyaWRZIH0sXG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZTogc3ByaXRlc1tgJHtpdGVtLnR5cGV9LSR7aXRlbS5sZXZlbH1gXSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogaXRlbS50eXBlLFxuICAgICAgICAgICAgICAgICAgICBsZXZlbDogaXRlbS5sZXZlbFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpKys7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRyb3BYcEZvck1lcmdlKG51bVVwZ3JhZGVkKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG59XG4iXX0=
